<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tread and Trails</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a2b35 0%, #2c4756 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* --- Auth Overlay --- */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 43, 53, 0.95);
            backdrop-filter: blur(10px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .auth-container h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
             background: linear-gradient(45deg, #fff, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-container p {
            margin-bottom: 2rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .auth-tabs {
            display: flex;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 1rem;
        }

        .auth-tab.active {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .auth-form {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }
        
        .auth-form.active {
            display: flex;
        }
        
        .auth-form input {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #ff6b35;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .guest-login {
            margin-top: 1.5rem;
        }

        .guest-login a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .guest-login a:hover {
            color: #ff6b35;
        }

        /* Header */
        .header {
            background: rgba(26, 43, 53, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo img {
            height: 45px;
        }
        
        .logo span {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-links a:hover {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .profile-btn:hover {
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .hero {
            text-align: center;
            padding: 4rem 0;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><path fill="%23ff6b35" opacity="0.1" d="M0,400 Q300,200 600,400 T1200,400 L1200,0 L0,0 Z"/></svg>');
            background-size: cover;
            border-radius: 20px;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #fff, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            border: none;
            background: none;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Marketplace Filters */
        .filters {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #fff;
        }

        .filter-group select, .filter-group input {
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
        }

        .filter-group select option {
            background: #1a2b35;
            color: #fff;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(255, 107, 53, 0.5);
        }

        .product-image {
            height: 200px;
            position: relative;
            overflow: hidden;
            background-color: #2c4756;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #fff;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            align-items: center;
        }

        .like-btn, .share-btn, .message-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .like-btn:hover, .share-btn:hover, .message-btn:hover {
            background: rgba(255, 107, 53, 0.3);
            transform: scale(1.1);
        }

        .like-btn.liked {
            background: #ff6b35;
        }

        .verified-badge {
            background: #28a745;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        /* Post Form */
        .post-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #fff;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group select option {
            background: #1a2b35;
            color: #fff;
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }
        
        /* --- Messages Section --- */
        .messaging-layout {
            display: flex;
            gap: 1.5rem;
            height: 70vh;
            max-height: 700px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .conversation-list {
            flex: 0 0 300px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding-right: 1.5rem;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .conversation-item.active {
            background: #ff6b35;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .conversation-details {
             overflow: hidden;
        }

        .conversation-details p {
            margin: 0;
            line-height: 1.3;
        }

        .conversation-user {
            font-weight: bold;
        }

        .conversation-preview {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .message-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid #ff6b35;
            max-width: 80%;
            align-self: flex-start;
        }
        
        .message.from-me {
            background: rgba(255, 107, 53, 0.2);
            border-left: none;
            border-right: 4px solid #ff6b35;
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: bold;
            color: #ff6b35;
        }
        
        .message.from-me .message-sender {
            color: #f7931e;
        }

        .message-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        #typing-indicator {
            align-self: flex-start;
            color: rgba(255,255,255,0.6);
            font-style: italic;
        }

        .message-input {
            display: flex;
            gap: 1rem;
        }

        .message-input input {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .send-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        /* Community Posts */
        .post {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }
        
        .post:hover {
            border: 1px solid rgba(255,107,53,0.5);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .post-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(38, 65, 81, 0.8));
        }

        .post-image {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
            background-color: #2c4756;
        }
        
        .post-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .post-action {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-action:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .post-action.active {
            color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }
        
        /* --- Profile Page --- */
        #profile .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            background: rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        #profile .profile-avatar {
             width: 100px;
            height: 100px;
            font-size: 3rem;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        #profile .profile-info h2 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        #profile h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 0.5rem;
        }
        
        .profile-grid-post {
            cursor: default !important;
        }
        
        .profile-grid-post:hover {
             border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        
        
        /* --- Post Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #1a2b35;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2.5rem;
            color: #fff;
            cursor: pointer;
            line-height: 1;
            z-index: 10;
        }
        
        .modal-image {
            width: 100%;
            height: 500px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .modal-text {
            padding: 2rem;
            overflow-y: auto;
        }

        .modal-text .post-meta {
            margin-bottom: 1rem;
        }
        
        .modal-text .post-content {
            max-height: none; /* remove height limit */
        }
        
        .modal-text .post-content::after {
            display: none; /* remove gradient */
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .messaging-layout {
                flex-direction: column;
                height: 80vh;
            }
            
            .conversation-list {
                flex: 0 0 120px;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                padding-right: 0;
                padding-bottom: 1rem;
                display: flex;
                flex-direction: row;
                gap: 1rem;
            }
            
            .conversation-item {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
                text-align: center;
            }
            
            .conversation-preview {
                display: none;
            }

        }

        /* Utility Classes */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 1rem; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-container">
            <div class="auth-tabs">
                <button id="signup-tab" class="auth-tab active" onclick="switchAuthTab('signup')">Sign Up</button>
                <button id="login-tab" class="auth-tab" onclick="switchAuthTab('login')">Login</button>
            </div>
            
            <form id="signup-form" class="auth-form active" onsubmit="enterSite(event)">
                <h2>Join the Community</h2>
                <p>Create an account to buy, sell, and share.</p>
                <input type="email" placeholder="Email Address" required>
                <input type="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>

            <form id="login-form" class="auth-form" onsubmit="enterSite(event)">
                <h2>Welcome Back!</h2>
                <p>Login to continue your adventure.</p>
                <input type="email" placeholder="Email Address" required>
                <input type="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <div class="guest-login">
                <a href="#" onclick="enterSite(event)">or Continue as a Guest</a>
            </div>
        </div>
    </div>


    <header class="header" style="display: none;">
        <nav class="nav container">
            <a href="#" class="logo" onclick="showTab('marketplace')">
                <img src="https://i.postimg.cc/yxH7cB7z/Adobe-Express-file-1.png" alt="Tread & Trails Logo">
                <span>Tread & Trails</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" onclick="showTab('marketplace')">Marketplace</a></li>
                <li><a href="#" onclick="showTab('community')">Community</a></li>
                <li><a href="#" onclick="showTab('messages')">Messages</a></li>
                <li><a href="#" onclick="showTab('post')">Post</a></li>
                <li><a href="#" onclick="showTab('profile')">Profile</a></li>
            </ul>
            <div class="user-menu">
                <button class="profile-btn" onclick="showTab('profile')"></button>
            </div>
        </nav>
    </header>

    <main class="main-content container" style="display: none;">
        <!-- Hero Section -->
        <section class="hero">
            <h1>Your 4WD & Camping Community</h1>
            <p>Buy, sell, and share your adventures with fellow off-road enthusiasts</p>
            <div class="cta-buttons">
                <button class="btn btn-primary" onclick="showTab('marketplace')">Browse Marketplace</button>
                <button class="btn btn-secondary" onclick="showTab('post')">Post Your Gear</button>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="marketplace" onclick="showTab('marketplace')">üõí Marketplace</button>
            <button class="tab" data-tab="community" onclick="showTab('community')">üë• Community</button>
            <button class="tab" data-tab="messages" onclick="showTab('messages')">üí¨ Messages</button>
            <button class="tab" data-tab="post" onclick="showTab('post')">üìù Post</button>
            <button class="tab" data-tab="profile" onclick="showTab('profile')">üë§ Profile</button>
        </div>

        <!-- Marketplace Section -->
        <section id="marketplace" class="content-section active">
            <div class="filters">
                <h3>Search & Filter</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="category" onchange="updateFilters()">
                            <option value="">All Categories</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="parts">Parts</option>
                            <option value="gear">Camping Gear</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Make/Brand</label>
                        <select id="make">
                            <option value="">Any Make</option>
                            <option value="toyota">Toyota</option>
                            <option value="ford">Ford</option>
                            <option value="jeep">Jeep</option>
                            <option value="arb">ARB</option>
                            <option value="tjm">TJM</option>
                            <option value="dometic">Dometic</option>
                            <option value="kings">Adventure Kings</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Condition</label>
                        <select id="condition">
                            <option value="">Any Condition</option>
                            <option value="new">New</option>
                            <option value="used">Used</option>
                            <option value="refurbished">Refurbished</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Price Range</label>
                        <input type="range" id="priceRange" min="0" max="100000" value="100000" onchange="updatePriceDisplay()">
                        <span id="priceDisplay">Up to $100,000</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>

            <div class="product-grid" id="productGrid">
                <!-- Products will be populated by JavaScript -->
            </div>
        </section>

        <!-- Community Section -->
        <section id="community" class="content-section">
            <div id="communityPosts">
                <!-- Posts will be populated by JavaScript -->
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="content-section">
            <div class="messaging-layout">
                <div class="conversation-list" id="conversationList">
                    <!-- Conversation contacts will be populated here -->
                </div>
                <div class="chat-window">
                    <div class="message-list" id="messageList">
                         <!-- Messages will be populated here -->
                    </div>
                    <div class="message-input">
                        <input type="text" id="messageInput" placeholder="Select a conversation...">
                        <button class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </section>


        <!-- Post Section -->
        <section id="post" class="content-section">
            <div class="post-form">
                <h3>Create New Listing or Post</h3>
                <form id="postForm" onsubmit="handlePostSubmission(event)">
                    <div class="form-group">
                        <label>Post Type</label>
                        <select id="postType" onchange="updatePostForm()">
                            <option value="marketplace">Marketplace Listing</option>
                            <option value="advice">Share Advice</option>
                            <option value="trip">Trip Report</option>
                            <option value="campsite">Campsite Review</option>
                        </select>
                    </div>
                    
                    <div id="marketplaceFields">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="postCategory">
                                <option value="vehicles">Vehicles</option>
                                <option value="parts">Parts</option>
                                <option value="gear">Camping Gear</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" id="postPrice" placeholder="Enter price">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="postTitle" placeholder="Enter title" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="postDescription" rows="5" placeholder="Describe your item or share your experience..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Photos/Videos</label>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <p>üì∏ Click to upload photos or videos</p>
                            <input type="file" id="fileInput" onchange="handleFileUpload(event)" multiple accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Post Now</button>
                </form>
            </div>
        </section>
        
        <!-- Profile Section -->
        <section id="profile" class="content-section">
             <div class="profile-header">
                <div id="profileAvatar" class="profile-avatar"></div>
                <div class="profile-info">
                    <h2 id="profileUsername"></h2>
                </div>
            </div>
            
            <h3>My Marketplace Listings</h3>
            <div id="profileListingsGrid" class="product-grid">
                <!-- User's listings will be populated here -->
            </div>
            
            <h3>My Community Posts</h3>
            <div id="profilePostsGrid">
                 <!-- User's posts will be populated here -->
            </div>
        </section>
        
    </main>
    
    <!-- Post Modal -->
    <div id="post-modal" class="modal-overlay" style="display: none;" onclick="closePostModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closePostModal()">&times;</span>
            <div id="modal-image" class="modal-image"></div>
            <div class="modal-text">
                 <div id="modal-header" class="post-header" style="margin-bottom: 1rem;">
                    <div id="modal-avatar" class="post-avatar"></div>
                    <div class="post-meta">
                        <div id="modal-author" class="post-author"></div>
                        <div id="modal-time" class="post-time"></div>
                    </div>
                </div>
                <div id="modal-content" class="post-content"></div>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        let products = [
            { id: 1, title: "2018 Toyota Land Cruiser 200 Series", price: 85000, category: "vehicles", make: "toyota", condition: "used", description: "Fully equipped tourer with lift kit, winch, and camping setup. Ready for the big lap.", verified: true, likes: 24, seller: "Mike Adventures", imageUrl: "https://carsguide-res.cloudinary.com/image/upload/e_trim:10,f_auto/c_scale,t_cg_base,w_345/v1/editorial/vhs/Toyota-LandCruiser_0.png" },
            { id: 2, title: "ARB Rooftop Tent - Simpson III", price: 2500, category: "gear", make: "arb", condition: "used", description: "Excellent condition rooftop tent, includes annex. Perfect for weekend adventures.", verified: false, likes: 12, seller: "Sarah Camping", imageUrl: "https://www.arb.com.au/wp-content/uploads/2014/04/rooftop5.jpg" },
            { id: 3, title: "Ford Ranger Bullbar - ARB Deluxe", price: 1200, category: "parts", make: "arb", condition: "new", description: "Brand new ARB Deluxe bullbar for Ford Ranger (PX2), still in box. Winch compatible.", verified: true, likes: 8, seller: "Parts Pro", imageUrl: "https://www.arb.com.au/wp-content/uploads/2022/05/P5100265.jpg" },
            { id: 4, title: "Adventure Kings Fridge 60L", price: 599, category: "gear", make: "kings", condition: "new", description: "Portable fridge freezer, perfect for long trips. Comes with 12v and 240v leads.", verified: false, likes: 15, seller: "Gear Hub", imageUrl: "https://cdn.productreview.com.au/resize/review-attachment/b3df0283-6b19-49c6-80ea-1ed68a3e62e5?cover=true&v=4&width=720&withoutEnlargement=true" },
            { id: 5, title: "2021 Ford Ranger Wildtrak", price: 65000, category: "vehicles", make: "ford", condition: "used", description: "Low kms, meticulously maintained. Comes with canopy and drawer system.", verified: true, likes: 18, seller: "Ranger Life", imageUrl: "https://carsguide-res.cloudinary.com/image/upload/f_auto,fl_lossy,q_auto,t_default/v1/editorial/segment_review/hero_image/2021-Ford-Ranger-Wildtrak-X-silver-1001x5565.jpeg" },
            { id: 6, title: "TJM Outback Bullbar for Prado 150", price: 1800, category: "parts", make: "tjm", condition: "used", description: "Used TJM bullbar, a few minor scratches but solid. All fittings included.", verified: true, likes: 5, seller: "PradoParts", imageUrl: "https://www.complete4x4.au/wp-content/uploads/2020/04/prado2018.png" },
            { id: 7, title: "Dometic CFX3 75DZ Fridge Freezer", price: 1500, category: "gear", make: "dometic", condition: "used", description: "Dual zone fridge/freezer, works perfectly. Includes insulated cover and stand.", verified: false, likes: 22, seller: "ColdBeerCarl", imageUrl: "https://www.frontrunneroutfitters.com/media/catalog/product/cache/d4dac59584c08d49306c6dda7f8649da/n/_/n_frid099_01.jpg?width=360&height=270&fit=cover" },
            { id: 8, title: "Old Man Emu BP-51 Suspension Kit", price: 4500, category: "parts", make: "old-man-emu", condition: "new", description: "Brand new, never fitted. Suits Land Cruiser 79 series. The best suspension money can buy.", verified: true, likes: 9, seller: "SuspensionSolutions", imageUrl: "https://images.squarespace-cdn.com/content/v1/5d26625bd154b8000136f695/1574409689265-4YGOXR0ZCGM1MLC0XFRP/bp51base_1.jpg" }
        ];

        let communityPosts = [
            { id: 1, author: "TrailBlazer89", verified: true, time: "2 hours ago", content: "Just completed the Canning Stock Route! What an incredible journey. The track conditions were challenging but manageable with proper preparation. Here are some tips for anyone planning this epic adventure: \n\n1. Drop your tire pressures WAY down for the dunes. I was running 18psi cold.\n2. Carry at least two spare tires. The track is notorious for shredding rubber.\n3. Fuel management is key. Know your consumption and plan your drops carefully at Kunawarritji.\n4. Take your time and enjoy the scenery. It's not a race!", likes: 42, comments: 15, shares: 8, hasImage: true, imageUrl: "https://live-production.wcms.abc-cdn.net.au/56895d59cd5e59e6bf33d5120619f4f2?impolicy=wcms_crop_resize&cropH=1381&cropW=2464&xPos=28&yPos=363&width=862&height=485" },
            { id: 2, author: "CampingQueen", verified: false, time: "5 hours ago", content: "Found this amazing free campsite near Karalee Rocks. Crystal clear water, perfect for swimming and fishing. GPS coordinates in comments!", likes: 67, comments: 23, shares: 31, hasImage: true, imageUrl: "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?q=80&w=1770&auto=format&fit=crop" },
            { id: 3, author: "MechMaster", verified: true, time: "1 day ago", content: "PSA: Check your diff oils before long trips! Just helped a fellow traveler who lost his diff on the Gibb River Road. Prevention is better than breakdown recovery!", likes: 28, comments: 9, shares: 12, hasImage: false },
            { id: 4, author: "JeepLifeAU", verified: false, time: "2 days ago", content: "Any recommendations for a reliable mechanic in the Perth area that specializes in Jeeps? My JK is making a weird noise from the front diff...", likes: 12, comments: 18, shares: 2, hasImage: false },
            { id: 5, author: "PatrolPower", verified: true, time: "3 days ago", content: "Finished the new drawer setup in the back of the GU Patrol. So much more organized now! Ready for Fraser Island next month.", likes: 55, comments: 21, shares: 10, hasImage: true, imageUrl: "https://www.drifta.com.au/wp-content/uploads/2014/01/Nissan-Patrol-Storage-Drawer-Package11.jpg" },
            { id: 6, author: "Newbie4x4", verified: false, time: "4 days ago", content: "First time taking the new rig out to the Glass House Mountains. It was a bit muddy but so much fun! Can't wait to go back.", likes: 31, comments: 7, shares: 3, hasImage: true, imageUrl: "https://live-production.wcms.abc-cdn.net.au/e5a1fb938ac8fa2beca7663c3bd3f457?impolicy=wcms_crop_resize&cropH=1680&cropW=2237&xPos=574&yPos=0&width=862&height=647" }
        ];

        let allMessages = {
            "Mike Adventures": [
                { sender: "You", time: "yesterday", content: "Hey Mike, is the Land Cruiser still for sale?" },
                { sender: "Mike Adventures", time: "yesterday", content: "G'day mate, sure is. She's a beauty." }
            ],
            "Sarah Camping": [
                { sender: "You", time: "3 hours ago", content: "Is the rooftop tent still available?" },
                { sender: "Sarah Camping", time: "2 hours ago", content: "Hi! Yes it is." }
            ],
            "Parts Pro": [
                { sender: "You", time: "4 hours ago", content: "Hi, does the bullbar come with all the mounting bolts?" },
                { sender: "Parts Pro", time: "3 hours ago", content: "Yep, full kit is included, still in the plastic." }
            ],
             "ColdBeerCarl": [
                 { sender: "You", time: "2 days ago", content: "Hey mate, interested in the Dometic fridge. Does it come with the 12v cable?" },
                 { sender: "ColdBeerCarl", time: "2 days ago", content: "Yep, comes with both the 12v and 240v cables, plus the insulated cover." }
            ]
        };

        // --- APP LOGIC ---
        let currentUser = { name: "Guest", avatar: "GU" };
        let currentTab = 'marketplace';
        let currentConversation = null;
        let likedPosts = new Set();
        let likedProducts = new Set();
        let uploadedFileUrl = null;
        const GEMINI_API_KEY = "AIzaSyASq40lL2qmXavBQafuQrCi3yiZT1tMCKI";

        const defaultImageUrl = "https://images.unsplash.com/photo-1574484284000-0196248a7374?q=80&w=1770&auto=format&fit=crop";

        function populateAllMessageContacts() {
            const allSellers = new Set(products.map(p => p.seller));
            allSellers.forEach(seller => {
                if (!allMessages[seller]) {
                    allMessages[seller] = [];
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
             populateAllMessageContacts();
             document.addEventListener('keydown', (e) => e.key === 'Enter' && e.target.id === 'messageInput' && sendMessage());
        });

        // --- Auth Functions ---
        function switchAuthTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-form`).classList.add('active');
        }

        function enterSite(event) {
            event.preventDefault();
            const form = event.target.closest('form');
            if (form) {
                const emailInput = form.querySelector('input[type="email"]');
                if (emailInput && emailInput.value) {
                    currentUser.name = emailInput.value;
                    currentUser.avatar = emailInput.value.substring(0, 2).toUpperCase();
                }
            } else {
                 currentUser.name = "Guest";
                 currentUser.avatar = "GU";
            }
            updateUserUI();
            const authOverlay = document.getElementById('auth-overlay');
            authOverlay.style.opacity = '0';
            setTimeout(() => {
                authOverlay.style.display = 'none';
                document.querySelector('.header').style.display = 'block';
                document.querySelector('.main-content').style.display = 'block';
                renderProducts();
                renderCommunityPosts();
                renderConversations();
                if(currentConversation) renderMessages(); else document.getElementById('messageList').innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.5);">Select a conversation to start chatting.</p>`;
            }, 500);
        }
        
        function updateUserUI() {
            document.querySelector('.profile-btn').textContent = currentUser.avatar;
        }

        // --- Main App Functions ---
        function showTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'profile') renderProfilePage();
            if (tabName === 'marketplace') renderProducts();
            if (tabName === 'community') renderCommunityPosts();
            
            currentTab = tabName;
        }

        function renderProducts(filteredProducts = products) {
            const grid = document.getElementById('productGrid');
            if (!grid) return;
            const productsToRender = filteredProducts;
            grid.innerHTML = productsToRender.map(product => `
                <div class="product-card" data-id="${product.id}" data-category="${product.category}" data-make="${product.make}" data-condition="${product.condition}" data-price="${product.price}">
                    <div class="product-image"> <img src="${product.imageUrl || defaultImageUrl}" alt="${product.title}"> </div>
                    <div class="product-info">
                        <div class="product-title">${product.title}</div> <div class="product-price">$${product.price.toLocaleString()}</div> <div class="product-description">${product.description}</div>
                        <div class="product-actions">
                            <div> <button class="like-btn ${likedProducts.has(product.id) ? 'liked' : ''}" onclick="toggleLike('product', ${product.id})"> ‚ù§Ô∏è <span class="like-count">${product.likes}</span> </button> <button class="share-btn" onclick="shareProduct(${product.id})">üì§</button> <button class="message-btn" onclick="messageUser('${product.seller}')">üí¨</button> </div>
                            <div> ${product.verified ? '<span class="verified-badge">‚úì Verified</span>' : ''} <small>by ${product.seller}</small> </div>
                        </div>
                    </div>
                </div>`).join('');
        }

        function renderCommunityPosts() {
            const container = document.getElementById('communityPosts');
             if (!container) return;
            container.innerHTML = communityPosts.map(post => `
                <div class="post" onclick="showPostModal(${post.id})">
                    <div class="post-header">
                        <div class="post-avatar">${post.author.substring(0,2).toUpperCase()}</div>
                        <div class="post-meta">
                            <div class="post-author"> ${post.author} ${post.verified ? '<span class="verified-badge">‚úì Verified</span>' : ''} </div>
                            <div class="post-time">${post.time}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>
                    ${post.hasImage ? `<div class="post-image"><img src="${post.imageUrl || defaultImageUrl}" alt="Post Image"></div>` : ''}
                    <div class="post-actions" onclick="event.stopPropagation()">
                        <button class="post-action ${likedPosts.has(post.id) ? 'active' : ''}" onclick="toggleLike('post', ${post.id})"> ‚ù§Ô∏è ${post.likes} Likes </button>
                        <button class="post-action" onclick="showComments(${post.id})"> üí¨ ${post.comments} Comments </button>
                        <button class="post-action" onclick="sharePost(${post.id})"> üì§ ${post.shares} Shares </button>
                    </div>
                </div>`).join('');
        }
        
        // --- Messaging Functions ---
        async function getAiReply(conversationHistory, recipientName) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = `You are ${recipientName}, a person involved in the 4WD and camping community. Your persona is casual, friendly, and a bit busy. Keep your replies short, conversational, and human-like. Don't be overly enthusiastic or use corporate language. Here is the conversation history with a user named "${currentUser.name}":\n\n${conversationHistory}\n\nNow, provide a natural, brief reply from ${recipientName}'s perspective.`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.8, maxOutputTokens: 60 }
                    })
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                return data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("AI Reply Error:", error);
                return "Sorry, I'm a bit busy right now. Can I get back to you later?";
            }
        }

        function renderConversations() {
            const container = document.getElementById('conversationList');
            const sortedContacts = Object.keys(allMessages)
                .filter(name => name !== currentUser.name) // Don't show self in contacts
                .sort((a, b) => {
                    const lastMsgA = allMessages[a][allMessages[a].length - 1];
                    const lastMsgB = allMessages[b][allMessages[b].length - 1];
                    if (!lastMsgA) return 1;
                    if (!lastMsgB) return -1;
                    // This is a simplification. A real implementation would parse dates.
                    return 0; 
                });

            container.innerHTML = sortedContacts.map(username => {
                const messages = allMessages[username];
                const lastMessage = messages[messages.length - 1];
                const preview = lastMessage ? lastMessage.content : "No messages yet";
                
                return `
                    <div class="conversation-item ${username === currentConversation ? 'active' : ''}" onclick="switchConversation('${username}')">
                        <div class="conversation-avatar">${username.substring(0,2).toUpperCase()}</div>
                        <div class="conversation-details">
                            <p class="conversation-user">${username}</p>
                            <p class="conversation-preview">${lastMessage && lastMessage.sender === currentUser.name ? "You: " : ""}${preview}</p>
                        </div>
                    </div>
                `
            }).join('');
        }
        
        function renderMessages() {
            const container = document.getElementById('messageList');
            if (!currentConversation) {
                container.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.5);">Select a conversation to start chatting.</p>`;
                return;
            }
            const messages = allMessages[currentConversation] || [];
            if (messages.length === 0) {
                 container.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.5);">No messages yet. Say hi!</p>`;
                 return;
            }
            container.innerHTML = messages.map(message => `
                <div class="message ${message.sender === currentUser.name ? 'from-me' : ''}">
                    <div class="message-header"> <span class="message-sender">${message.sender}</span> <span class="message-time">${message.time}</span> </div>
                    <div class="message-content">${message.content}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function switchConversation(username) {
            currentConversation = username;
            document.getElementById('messageInput').placeholder = `Message ${username}...`;
            renderConversations();
            renderMessages();
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            if (!messageText || !currentConversation) return;

            allMessages[currentConversation].push({ sender: currentUser.name, time: 'just now', content: messageText });
            renderMessages();
            messageInput.value = '';

            const messageList = document.getElementById('messageList');
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.textContent = `${currentConversation} is typing...`;
            messageList.appendChild(typingIndicator);
            messageList.scrollTop = messageList.scrollHeight;

            const conversationHistory = allMessages[currentConversation].map(m => `${m.sender}: ${m.content}`).join('\n');
            const aiReplyText = await getAiReply(conversationHistory, currentConversation);
            
            document.getElementById('typing-indicator')?.remove();
            allMessages[currentConversation].push({ sender: currentConversation, time: 'just now', content: aiReplyText });
            renderMessages();
            renderConversations();
        }
        
        function messageUser(username) {
            event.stopPropagation();
            if (username === currentUser.name) {
                 showNotification("You can't message yourself!");
                 return;
            }
            showTab('messages');
            if (!allMessages[username]) allMessages[username] = [];
            switchConversation(username);
            document.getElementById('messageInput').focus();
        }

        function applyFilters() {
            const category = document.getElementById('category').value;
            const make = document.getElementById('make').value;
            const condition = document.getElementById('condition').value;
            const maxPrice = parseInt(document.getElementById('priceRange').value);

            const filtered = products.filter(product => {
                const matchesCategory = !category || product.category === category;
                const matchesMake = !make || product.make === make;
                const matchesCondition = !condition || product.condition === condition;
                const matchesPrice = product.price <= maxPrice;
                return matchesCategory && matchesMake && matchesCondition && matchesPrice;
            });

            renderProducts(filtered);
        }

        function updatePostForm() {
            const postType = document.getElementById('postType').value;
            document.getElementById('marketplaceFields').style.display = (postType === 'marketplace') ? 'block' : 'none';
        }

        function handlePostSubmission(e) {
            e.preventDefault();
            const form = document.getElementById('postForm');
            const postType = document.getElementById('postType').value;
            const title = document.getElementById('postTitle').value;
            const description = document.getElementById('postDescription').value;
            
            if (postType === 'marketplace') {
                const newProduct = {
                    id: Date.now(), title: title, price: parseInt(document.getElementById('postPrice').value) || 0,
                    category: document.getElementById('postCategory').value, make: 'unknown', condition: 'used',
                    description: description, verified: true, likes: 0, seller: currentUser.name,
                    imageUrl: uploadedFileUrl || defaultImageUrl
                };
                products.unshift(newProduct);
                showNotification('Marketplace listing created!');
                showTab('marketplace');
            } else {
                const newPost = {
                    id: Date.now(), author: currentUser.name, verified: true, time: 'just now', content: description,
                    likes: 0, comments: 0, shares: 0, hasImage: !!uploadedFileUrl, imageUrl: uploadedFileUrl || defaultImageUrl
                };
                communityPosts.unshift(newPost);
                showNotification('Community post created!');
                showTab('community');
            }
            
            form.reset();
            uploadedFileUrl = null;
            document.querySelector('.file-upload p').textContent = 'üì∏ Click to upload photos or videos';
            updatePostForm();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                uploadedFileUrl = URL.createObjectURL(file);
                document.querySelector('.file-upload p').textContent = `üìÅ ${file.name}`;
            }
        }
        
        function renderProfilePage() {
            document.getElementById('profileAvatar').innerText = currentUser.avatar;
            document.getElementById('profileUsername').innerText = currentUser.name;
            const listingsGrid = document.getElementById('profileListingsGrid');
            const postsGrid = document.getElementById('profilePostsGrid');
            const myProducts = products.filter(p => p.seller === currentUser.name);
            const myPosts = communityPosts.filter(p => p.author === currentUser.name);

            listingsGrid.innerHTML = myProducts.length > 0 ? myProducts.map(p => `<div class="product-card"><div class="product-image"><img src="${p.imageUrl || defaultImageUrl}" alt="${p.title}"></div><div class="product-info"><div class="product-title">${p.title}</div><div class="product-price">$${p.price.toLocaleString()}</div></div></div>`).join('') : "<p>You haven't listed any items for sale yet.</p>";
            postsGrid.innerHTML = myPosts.length > 0 ? myPosts.map(p => `<div class="post profile-grid-post"><div class="post-header"><div class="post-avatar">${p.author.substring(0,2).toUpperCase()}</div><div class="post-meta"><div class="post-author">${p.author}</div><div class="post-time">${p.time}</div></div></div><div class="post-content">${p.content.replace(/\n/g, '<br>')}</div>${p.hasImage ? `<div class="post-image"><img src="${p.imageUrl || defaultImageUrl}" alt="Post Image"></div>` : ''}</div>`).join('') : "<p>You haven't made any community posts yet.</p>";
        }
        
        function showPostModal(postId) {
            const post = communityPosts.find(p => p.id === postId);
            if (!post) return;
            document.getElementById('modal-image').style.backgroundImage = `url(${post.imageUrl || defaultImageUrl})`;
            document.getElementById('modal-image').style.display = post.hasImage ? 'block' : 'none';
            document.getElementById('modal-avatar').innerText = post.author.substring(0,2).toUpperCase();
            document.getElementById('modal-author').innerText = post.author;
            document.getElementById('modal-time').innerText = post.time;
            document.getElementById('modal-content').innerHTML = post.content.replace(/\n/g, '<br>');
            document.getElementById('post-modal').style.display = 'flex';
        }
        
        function closePostModal() { document.getElementById('post-modal').style.display = 'none'; }
        
        function toggleLike(type, id) {
            event.stopPropagation();
            const set = type === 'product' ? likedProducts : likedPosts;
            const data = type === 'product' ? products : communityPosts;
            const item = data.find(item => item.id === id);
            set.has(id) ? (set.delete(id), item.likes--) : (set.add(id), item.likes++);
            if (currentTab === 'community') renderCommunityPosts();
            if (currentTab === 'marketplace') renderProducts();
        }

        function shareProduct(id) {
            event.stopPropagation();
            const product = products.find(p => p.id === id);
            if (!product) return;
            navigator.clipboard.writeText(`${product.title}: ${product.description}`).then(() => showNotification('Link copied to clipboard!'));
        }

        function sharePost(id) {
             event.stopPropagation();
            const post = communityPosts.find(p => p.id === id);
            if (post) {
                post.shares++;
                renderCommunityPosts();
                showNotification('Post shared!');
            }
        }

        function showComments(postId) {
            event.stopPropagation();
            showNotification('Comments feature coming soon!'); 
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `<div style="position: fixed; top: 100px; right: 20px; background: linear-gradient(45deg, #ff6b35, #f7931e); color: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;">${message}</div>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
    <style> @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } </style>
</body>
</html>